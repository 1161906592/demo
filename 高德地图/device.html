<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="author" content="丿Coder">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
  <title>device</title>
  <style>
  * {
    margin: 0;padding: 0;
  }

  .main {
    display: flex;
    height: 100vh;
  }

  #container {
    width: 90%;
  }
  </style>
  <script type="text/javascript"
          src="https://webapi.amap.com/maps?v=1.4.15&key=c1a1851e1d65f6e01d47c4781a4be455&plugin=AMap.MouseTool,AMap.PolyEditor,AMap.Polyline,AMap.Scale"></script>
</head>
<body>
<div class="main">
  <div id="container"></div>
  <div class="handle">
    <button onclick="handleRender()">渲染</button>
  </div>
</div>
<script>
var map = new AMap.Map("container", {
  center: [106.552588, 29.643322],
  zoom: 10
});
let data = [];
let retina = AMap.Browser.retina;
let maxR = retina ? 8 : 16;
let minR = retina ? 4 : 8;
let maxError = 50;

function getData (callback) {
  data = [];
  // 11406
  let errorNum = 0;
  for (let i = 0; i < 10000; i++) {
    let isError = ~~(Math.random() * 2) && (errorNum < maxError);
    if (isError) {
      errorNum++;
    }
    data.push({
      lng: 116 + Number((Math.random() * 10 - 12).toFixed(6)),
      lat: 29 + Number((Math.random() * 10 - 5).toFixed(6)),
      r: retina ? 4 : 8,
      speed: retina ? 0.1 : 0.2,
      error: isError
    })
  }
  callback(data);
}

var canvas = document.createElement("canvas");
canvas.onclick = (e) => {
  var ctx = canvas.getContext("2d");
  for (var i = 0; i < data.length; i += 1) {
    var center = [data[i].lng, data[i].lat];
    var pos = map.lngLatToContainer(center);
    if (retina) {
      pos = pos.multiplyBy(2);
    }
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, data[i].r, 0, 2 * Math.PI);
    if (ctx.isPointInPath(e.clientX, e.clientY)) {
      console.log(data[i]);
    }
  }
};

let rAFid;

function customLayer (positions) {
  AMap.plugin("AMap.CustomLayer", function () {
    var customLayer = new AMap.CustomLayer(canvas, {
      // zooms: [3, 10],
      alwaysRender: false, // 缩放过程中是否重绘，复杂绘制建议设为false
      zIndex: 120
    });
    customLayer.render = function () {
      cancelAnimationFrame(rAFid);
      var size = map.getSize();//resize
      var width = size.width;
      var height = size.height;
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      if (retina) {//高清适配
        width *= 2;
        height *= 2;
      }
      canvas.width = width;
      canvas.height = height;//清除画布
      var ctx = canvas.getContext("2d");
      ctx.fillStyle = "#08f";
      ctx.strokeStyle = "#fff";
      ctx.beginPath();
      for (var i = 0; i < positions.length; i += 1) {
        let item = positions[i];
        var center = [item.lng, item.lat];
        var pos = map.lngLatToContainer(center);
        if (item.error) {
          if (item.r > maxR || item.r < minR) {
            item.speed = -item.speed;
          }
          item.r += item.speed;
        }
        if (retina) {
          pos = pos.multiplyBy(2);
        }
        ctx.moveTo(pos.x, pos.y);
        ctx.arc(pos.x, pos.y, data[i].r, 0, 2 * Math.PI);
      }
      ctx.lineWidth = retina ? 6 : 3;
      ctx.closePath();
      ctx.stroke();
      ctx.fill();
      // rAFid = requestAnimationFrame(customLayer.render)
    };
    customLayer.setMap(map);
  });
}

function handleRender () {
  getData(customLayer);
}
</script>
</body>
</html>
